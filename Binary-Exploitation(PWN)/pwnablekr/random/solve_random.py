from pwn import *
import ctypes

# Setup
user = 'random'
host = 'pwnable.kr'
port = 2222
password = 'guest'

# Connect
s = ssh(user=user, host=host, port=port, password=password)

# Determine the random value on the SERVER
# We will compile a small C program on the server to be 100% sure what rand() returns there.
log.info("Checking rand() value on server...")
log.info("Checking rand() value on server using Python ctypes...")
# We use python on the server to call libc.rand() directly.
# This avoids writing files or using gcc which might fail.
check_cmd = "python3 -c \"import ctypes; libc = ctypes.CDLL('libc.so.6'); print(libc.rand())\""
try:
    r = s.process(['sh', '-c', check_cmd])
    rand_val_str = r.recvall().decode().strip()
    rand_val = int(rand_val_str)
    log.info(f"Server rand() value: {rand_val}")
    r.close()
except Exception as e:
    log.error(f"Failed to get random value: {e}")
    exit(1)

# Calculate Key
# key ^ random = 0xcafebabe
# key = random ^ 0xcafebabe
key = rand_val ^ 0xcafebabe
log.info(f"Calculated Key: {key}")

# Exploit
log.info("Sending payload...")
p = s.process(['./random'])
p.sendline(str(key))
p.recvline() # Good!

# Get Flag
try:
    flag = p.recvall().decode().strip()
    log.success(f"Flag: {flag}")
except:
    log.info("Could not auto-read flag. Switching to interactive.")
    p.interactive()
